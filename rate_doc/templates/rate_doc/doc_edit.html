{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}
{{doc.article_title}}
{% endblock %}

{% block content %}

<div class="row">
<div class="bg-dark text-light rounded" id="optionBox" style="display: none; z-index: 90000;">
  <h6>Label text as:</h6>
  <button onClick="copyDocumentText('Affiliation')" class="btn btn-primary btn-sm" type="button"><b>Affiliation</b></button>
  <button onClick="copyDocumentText('Source')" class="btn btn-primary btn-sm" type="button"><b>Source</b></button>
  <button onClick="copyDocumentText('Appeal')" class="btn btn-primary btn-sm" type="button"><b>Appeal</b></button>
</div>

<div style="overflow-y: auto;" class="col-4 h-100 bg-light text-secondary ">

<form id="report-form" method="post">{% csrf_token %}
    <div class="d-flex">
        <h4 class="pr-1">Report</h4>
        <button onClick='editReport();' type="button" class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Edit</button>
        <button type="submit" class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Save</button>
        <button onClick='showReport();' class="btn btn-secondary btn-sm pt-0 pb-0 m-1 align-self-center" type="button">Cancel</button>
    </div>

    <div id="report-home">
        <h6>Title</h6> {{doc.report.title}}
        <h6>Author</h6> {{doc.report.author}}
        <h6>Media Organization</h6> {{doc.report.media_org}}
        <h6>Section</h6> {{doc.report.section}}
        <h6>Page</h6> {{doc.report.page}}
    </div>
    <div id="report-edit" style="display:none;">
        
    </div>
</form>

<form id="affil-form" action="report-affiliation/add/" method="post">{% csrf_token %}
    <div class="d-flex">
        <h4 class="pr-1">Document Affiliations(s)</h4>
        <button type="button" onClick='addAffiliation();' class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Add</button>
        <button type="submit" class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Save</button>
        <button type="button" onClick='showAffiliations();' class="btn btn-secondary btn-sm pt-0 pb-0 m-1 align-self-center">Cancel</button>
    </div>
    <div id="affil-home">
        <ul>
        {% for a in doc.reportsourceaffiliation_set.all %}
            <li>{{a}}</li>
        {% empty %}
            No Document Affiliations Identified.
        {% endfor %}
        </ul>
    </div>
    <div id="affil-edit" class="w-100" style="display:none;"></div>
</form>

<form id="reportSource-form" action="report-source/add/" method="post">{% csrf_token %}
    <div class="d-flex">
        <h4 class="pr-1">Document Source(s)</h4>
        <button type="button" onClick='addSource();' class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Add</button>
        <button type="submit" class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Save</button>
        <button type="button" onClick='showSources();' class="btn btn-secondary btn-sm pt-0 pb-0 m-1 align-self-center">Cancel</button>
    </div>
    <div id="reportSource-home">
        <ul>
        {% for reportSource in doc.reportsource_set.all %}
            <li>{{reportSource}}</li>
        {% empty %}
            No Document Sources Identified.
        {% endfor %}
        </ul>    
    </div>
    <div id="reportSource-edit" style="display:none;">
        {{reportSource_form}}
    </div>
</form>

<form id="appeal-form" action="report-appeal/add/" method="post">{% csrf_token %}
    <div class="d-flex">
        <h4 class="pr-1">Document Appeal(s)</h4>
        <button type="button" onClick='addAppeal();' class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Add</button>
        <button type="submit" class="btn btn-primary btn-sm pt-0 pb-0 m-1 align-self-center">Save</button>
        <button type="button" onClick='showAppeals();' class="btn btn-secondary btn-sm pt-0 pb-0 m-1 align-self-center">Cancel</button>
    </div>
    <div id="appeal-home">
        {% for appeal in doc.report.appeal_set %}
        
        {% empty %}
            No Document Sources Identified.
        {% endfor %}    
    </div>
    <div id="appeal-edit" style="display:none;">
        {{appeal_form | crispy}}
    </div>
</form>
   

</div>
<div style="overflow-y: auto;" class="col-8">
<h3>Rated By: 
{% if doc.ratedBy %}
{{doc.ratedBy}}
{% else %}
unrated
{% endif %}
</h3>
<h5>Title: {{doc.report.title}}</h5>
<div id="report-container" style="position: relative;" class="bg-light">
    <div id="affiliations-bg-html" style="position: absolute; top: 0px;" class="text-bg">{{doc.report.report_text_html|linebreaksbr}}</div>
    <div id="sources-bg-html" style="position: absolute; top: 0px;" class="text-bg">{{doc.report.report_text_html|linebreaksbr}}</div>
    <div id="appeals-bg-html" style="position: absolute; top: 0px;" class="text-bg">{{doc.report.report_text_html|linebreaksbr}}</div>
    <div id="report-html" style="position: absolute; top: 0px;" class="text-dark">{{doc.report.report_text_html|linebreaksbr}}</div>
</div>

</div>
</div>

{% endblock %}

{% block extra_js %}
{{report_form.media.js}}
<script type="text/javascript" >

var highlightedText;
var range;

function clearSelection(){
    if (window.getSelection) {window.getSelection().removeAllRanges();}
    else if (document.selection) {document.selection.empty();}
}

$('#report-html').mouseup(function (e) {
	var selection = getSelection();
	range = selection.getRangeAt(0);
	console.log();
	var selectedText = selection.toString();
	$('#optionBox').hide();
	if (selectedText.length > 0) {
//		console.log(selectedText);
        $('#optionBox').css({'top':e.pageY-100,'left':e.pageX, 'position':'absolute', 'border':'1px solid black', 'padding':'5px'});
        $('#optionBox').show();
        highlightedText = selectedText;
	}
});

$('#optionBox').mouseup(function (e) {
	$(this).hide();
	clearSelection();
});

function editReport() {
    $.ajax({
        type: "GET",
        url: "/rate_doc/{{doc.report.id}}/report/update/",
        success: function(data){
            $('#report-edit').html(data);
            $('#report-home').fadeOut(function(){$('#report-edit').fadeIn();});
        }
    });
}

function showReport() {
    $('#report-edit').fadeOut(function (){$('#report-home').fadeIn()});
}

function addAffiliation() {
    $.ajax({
        type: "GET",
        url: "report-affiliation/add/",
        success: function(data){
            $('#affil-edit').html(data);
            
            $('#affil-home').fadeOut(function(){$('#affil-edit').fadeIn();});
        }
    });
}

function showAffiliations() {
    $('#affil-edit').fadeOut(function(){$('#affil-home').fadeIn()});
}

function addSource() {
    $.ajax({
        type: "GET",
        url: "report-source/add/",
        success: function(data){
            $('#reportSource-edit').html(data);
            $('#reportSource-home').fadeOut(function(){$('#reportSource-edit').fadeIn();});
        }
    });
}

function showSources() {
    $('#reportSource-edit').fadeOut(function(){$('#reportSource-home').fadeIn()});
}

function addAppeal() {
    $.ajax({
        type: "GET",
        url: "report-appeal/add/",
        success: function(data){
            $('#appeal-edit').html(data);
            $('#appeal-home').fadeOut(function(){$('#appeal-edit').fadeIn();});
        }
    });
}

function showAppeals() {
    $('#appeal-edit').fadeOut(function(){$('#appeal-home').fadeIn()});
}

function insertString(str,txt,pos){
    return [txt.slice(0,pos),str,txt.slice(pos)].join('');
}

function copyDocumentText(e){

    var span = document.createElement('span');

    if(e === 'Affiliation'){
        addAffiliation();
        $('#affil-edit :input.textarea').val(highlightedText).change();
        $(span).addClass('affil-highlight p-1 rounded');
    }
    if(e === 'Source'){
        addSource();
        $('#reportSource-edit :input.textarea').val(highlightedText).change();
        $(span).addClass('src-highlight p-1 rounded');
    }
    if(e === 'Appeal'){
        addAppeal();
        $('#appeal-edit :input.textarea').val(highlightedText).change();
        $(span).addClass('appeal-highlight p-1 rounded');
    }

    span.appendChild(range.extractContents());
    range.insertNode(span);     
}

$(document).ready(function () {
	$('#affil-form').ajaxForm({
	   target: $('#affil-edit'),
	   success: showAffiliations(),
	});
	
    $('#reportSource-form').ajaxForm({
	   target: $('#reportSource-edit'),
	   success: showSources(),
	});
});

</script>

{% endblock %}

{% block extra_css %}

<style type="text/css">
    input {
        width: 100%;    
    }
    select {
        width: 100%;    
    }
    textarea{
        font-size: 8pt;    
    }
    
    .text-bg{
        color: transparent;  
    }
    .affil-highlight{
        background-color: rgba(0,0,0,0.5);
        color: rgba(255,255,255,1);    
    }
    .src-highlight{
        background-color: rgba(100,0,0,0.5);
        color: rgba(255,255,255,1);    
    }
    .appeal-highlight{
        background-color: rgba(0,180,0,0.5);
        color: rgba(255,255,255,1);    
    }
</style>
{% endblock %}